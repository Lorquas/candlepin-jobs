---
- hosts: all
  become: true
  vars:
    jenkins_plugins:
      - ansible
      - ansicolor
      - config-file-provider
      - credentials-binding
      - email-ext
      - envinject
      - ghprb
      - git
      - github
      - htmlpublisher
      - ircbot
      - job-dsl
      - parameterized-trigger
      - uno-choice
      - workflow-aggregator
      - ws-cleanup
    CANDLEPIN_JENKINS_GITHUB_ORG: candlepin
  roles:
    - geerlingguy.jenkins

  tasks:
    - name: disable mail relay
      lineinfile: dest=/etc/postfix/main.cf line="default_transport = local:$myhostname"
      notify: reload postfix config

    - name: template development seed job
      template: src=templates/seed.groovy.j2 dest=/vagrant/ansible/seed.groovy

    - name: (re)generate development seed job
      command: ./gradlew rest -Dpattern=ansible/seed.groovy -DbaseUrl=http://{{ jenkins_hostname }}:{{ jenkins_http_port }}/ -Dusername={{ jenkins_admin_username }} -Dpassword={{ jenkins_admin_password }} chdir=/vagrant
      tags:
        - skip_ansible_lint

  handlers:
    - name: reload postfix config
      service: name=postfix state=reloaded

- hosts: all
  become: true
  vars:
    jenkins_dummy_configs:
      - candlepinPerformanceInventory

  tasks:
    - name: Wait for Jenkins to start up before proceeding.
      shell: "curl -D - --silent --max-time 5 http://localhost:8080/cli/"
      register: result
      until: (result.stdout.find("403 Forbidden") != -1) or (result.stdout.find("200 OK") != -1) and (result.stdout.find("Please wait while") == -1)
      retries: "60"
      delay: "5"
      changed_when: false

    - name: create dummy config files
      shell: >
        echo "javaposse.jobdsl.plugin.ConfigFileProviderHelper.findConfigProvider(javaposse.jobdsl.dsl.ConfigFileType.Custom).save(new org.jenkinsci.plugins.configfiles.custom.CustomConfig('{{ item }}', '{{ item }}', 'dummy file', ''))" |
        java -jar /opt/jenkins-cli.jar
        -s http://localhost:8080/
        groovy =
        --username admin --password admin
      with_items: "{{ jenkins_dummy_configs }}"
      tags:
        - dummyconfig
